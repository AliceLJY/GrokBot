<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GrokBot</title>
    <base href="/grokbot/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="GrokBot.styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css" integrity="sha512-UyNhw5RNpQaCai2EdC+Js0QL4RlVmiq41DkmCJsRV3ZxipG2L0HhTqIf/H9Hp8ez2EnFlkBnjRGJU2stW3Lj+w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <div id="app">
        <div class="loading-container">
            <div class="loading-text">
                <h1>GrokBot</h1>
                <p>载入中...</p>
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <div id="blazor-error-ui">
        发生了一个未处理的错误。
        <a href="" class="reload">重新加载</a>
        <a class="dismiss">🗙</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
    <script>
        // 为每个聊天ID单独设置会话存储缓存
        window.cacheChatForNavigation = function(chatId, chatJson) {
            if (!chatId || !chatJson) {
                console.error('无效的聊天ID或数据');
                return false;
            }
            
            try {
                sessionStorage.setItem('chat_cache_' + chatId, chatJson);
                console.log(`已缓存聊天 ${chatId} 到会话存储`);
                return true;
            } catch (e) {
                console.error('缓存聊天出错:', e);
                return false;
            }
        };
        
        // 获取聊天缓存
        window.getCachedChat = function(chatId) {
            if (!chatId) return null;
            
            try {
                const cachedChat = sessionStorage.getItem('chat_cache_' + chatId);
                if (cachedChat) {
                    console.log(`从会话存储中获取聊天缓存 ${chatId}`);
                }
                return cachedChat;
            } catch (e) {
                console.error('获取聊天缓存出错:', e);
                return null;
            }
        };
        
        // 导航到聊天页面的专用函数
        window.navigateToChat = function(chatId) {
            if (!chatId) {
                console.error('无效的聊天ID');
                return;
            }
            
            try {
                // 获取基础路径
                const baseHref = document.querySelector('base').getAttribute('href') || '/';
                const baseUrl = baseHref.endsWith('/') ? baseHref : baseHref + '/';
                
                // 记录详细日志
                console.log('导航到聊天，基础路径:', baseUrl);
                console.log('聊天ID:', chatId);
                
                // 构建完整URL
                const chatUrl = baseUrl + 'chat/' + chatId;
                console.log('完整URL:', chatUrl);
                
                // 记录导航前URL
                console.log('当前URL:', window.location.href);
                
                // 使用硬导航确保页面刷新
                window.location.href = chatUrl;
            } catch(e) {
                console.error('导航到聊天出错:', e);
                
                // 后备方案
                if (window.location.hostname.includes('github.io')) {
                    window.location.href = '/grokbot/chat/' + chatId;
                } else {
                    window.location.href = '/chat/' + chatId;
                }
            }
        };
        
        // 在页面加载时处理SPA路由问题
        window.addEventListener('load', function() {
            console.log('页面加载完成，初始化路由增强...');
            
            // 添加GitHub Pages的路由支持
            if (window.location.hostname.includes('github.io')) {
                // 如果当前在GitHub Pages并且页面被刷新（非Blazor导航）
                console.log('在GitHub Pages环境中运行');
                
                // 获取当前URL路径
                var path = window.location.pathname;
                console.log('当前路径:', path);
                
                // 检查是否是聊天页面路径的格式，但可能被截断
                // 例如 /grokbot/chat/123 可能被GitHub Pages返回404并重定向到 /grokbot/
                var baseHref = document.querySelector('base').getAttribute('href');
                console.log('Base Href:', baseHref);
                
                // 在会话存储中检查是否有保存的聊天URL
                var savedChatUrl = sessionStorage.getItem('currentChatUrl');
                if (savedChatUrl) {
                    console.log('找到保存的聊天URL:', savedChatUrl);
                    
                    // 如果被重定向到了根路径，但有保存的聊天URL，则恢复到那个URL
                    if (path === baseHref || path === baseHref.slice(0, -1)) {
                        console.log('检测到可能的重定向，正在恢复聊天URL');
                        // 保持URL但不要移除，因为如果导航失败，我们需要再次尝试
                        window.location.href = savedChatUrl;
                    }
                }
            }
            
            // 每次加载时自动显示调试信息
            window.showDebugInfo();
        });
        
        // 修复特殊处理所有 a 标签的点击事件
        document.addEventListener('click', function(e) {
            // 检查是否点击了a标签
            const anchor = e.target.closest('a');
            if (!anchor) return;
            
            // 检查是否是内部链接
            const href = anchor.getAttribute('href');
            if (!href || href.startsWith('http') || href.startsWith('//') || href.startsWith('#')) return;
            
            console.log('捕获链接点击: ' + href);
            
            // 获取当前base路径
            const base = document.querySelector('base').getAttribute('href') || '/';
            
            // 在GitHub Pages环境下重写链接
            if (window.location.hostname.includes('github.io')) {
                e.preventDefault();
                const newHref = base + href.replace(/^\//, '');
                console.log('重写链接: ' + newHref);
                window.location.href = newHref;
            }
        });

        // 保存/恢复聊天内容的功能增强
        window.saveChatToLocalStorage = function(chatId, messages) {
            try {
                localStorage.setItem('chat_' + chatId, JSON.stringify(messages));
                console.log('已保存聊天: ' + chatId);
                return true;
            } catch (e) {
                console.error('保存聊天出错: ', e);
                return false;
            }
        };

        window.loadChatFromLocalStorage = function(chatId) {
            try {
                const data = localStorage.getItem('chat_' + chatId);
                if (data) {
                    console.log('已加载聊天: ' + chatId);
                    return JSON.parse(data);
                }
                return null;
            } catch (e) {
                console.error('加载聊天出错: ', e);
                return null;
            }
        };
        
        // 调试信息 - 显示当前路径和本地存储信息
        window.showDebugInfo = function() {
            console.log('---- 调试信息 ----');
            console.log('当前URL:', window.location.href);
            console.log('基础路径:', document.querySelector('base').getAttribute('href'));
            
            // 显示所有会话存储
            console.log('会话存储:');
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                console.log(`  ${key}: ${sessionStorage.getItem(key).substring(0, 50)}...`);
            }
            
            // 显示所有聊天相关本地存储
            console.log('聊天存储:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('chat_')) {
                    const chatId = key.replace('chat_', '');
                    const data = JSON.parse(localStorage.getItem(key));
                    console.log(`  ${chatId}: 消息数=${data.length || 0}`);
                }
            }
            
            console.log('---------------');
        };

        // 修复ScrollToBottom功能
        window.scrollToBottom = function(elementId) {
            try {
                if (typeof elementId === 'object') {
                    // 如果传入的是ElementReference
                    elementId.scrollTop = elementId.scrollHeight;
                } else {
                    // 如果传入的是ID字符串
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.scrollTop = element.scrollHeight;
                    }
                }
            } catch (e) {
                console.error('滚动到底部出错: ', e);
            }
        };
        
        // 如果检测到是聊天页面，设置URL
        if (window.location.pathname.includes('/chat/')) {
            console.log('检测到聊天页面, 保存URL到会话存储');
            sessionStorage.setItem('currentChatUrl', window.location.href);
            
            // 提取聊天ID并尝试记录
            try {
                const pathParts = window.location.pathname.split('/');
                const chatId = pathParts[pathParts.length - 1];
                console.log('检测到聊天ID:', chatId);
            } catch (e) {
                console.error('无法提取聊天ID:', e);
            }
        }
    </script>
</body>

</html>
