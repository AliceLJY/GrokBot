<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GrokBot</title>
    <base href="/grokbot/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="GrokBot.styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css" integrity="sha512-UyNhw5RNpQaCai2EdC+Js0QL4RlVmiq41DkmCJsRV3ZxipG2L0HhTqIf/H9Hp8ez2EnFlkBnjRGJU2stW3Lj+w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <div id="app">
        <div class="loading-container">
            <div class="loading-text">
                <h1>GrokBot</h1>
                <p>è½½å…¥ä¸­...</p>
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <div id="blazor-error-ui">
        å‘ç”Ÿäº†ä¸€ä¸ªæœªå¤„ç†çš„é”™è¯¯ã€‚
        <a href="" class="reload">é‡æ–°åŠ è½½</a>
        <a class="dismiss">ğŸ—™</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
    <script>
        // ä¸ºæ¯ä¸ªèŠå¤©IDå•ç‹¬è®¾ç½®ä¼šè¯å­˜å‚¨ç¼“å­˜
        window.cacheChatForNavigation = function(chatId, chatJson) {
            if (!chatId || !chatJson) {
                console.error('æ— æ•ˆçš„èŠå¤©IDæˆ–æ•°æ®');
                return false;
            }
            
            try {
                sessionStorage.setItem('chat_cache_' + chatId, chatJson);
                console.log(`å·²ç¼“å­˜èŠå¤© ${chatId} åˆ°ä¼šè¯å­˜å‚¨`);
                return true;
            } catch (e) {
                console.error('ç¼“å­˜èŠå¤©å‡ºé”™:', e);
                return false;
            }
        };
        
        // è·å–èŠå¤©ç¼“å­˜
        window.getCachedChat = function(chatId) {
            if (!chatId) return null;
            
            try {
                const cachedChat = sessionStorage.getItem('chat_cache_' + chatId);
                if (cachedChat) {
                    console.log(`ä»ä¼šè¯å­˜å‚¨ä¸­è·å–èŠå¤©ç¼“å­˜ ${chatId}`);
                }
                return cachedChat;
            } catch (e) {
                console.error('è·å–èŠå¤©ç¼“å­˜å‡ºé”™:', e);
                return null;
            }
        };
        
        // å¯¼èˆªåˆ°èŠå¤©é¡µé¢çš„ä¸“ç”¨å‡½æ•°
        window.navigateToChat = function(chatId) {
            if (!chatId) {
                console.error('æ— æ•ˆçš„èŠå¤©ID');
                return;
            }
            
            try {
                // è·å–åŸºç¡€è·¯å¾„
                const baseHref = document.querySelector('base').getAttribute('href') || '/';
                const baseUrl = baseHref.endsWith('/') ? baseHref : baseHref + '/';
                
                // è®°å½•è¯¦ç»†æ—¥å¿—
                console.log('å¯¼èˆªåˆ°èŠå¤©ï¼ŒåŸºç¡€è·¯å¾„:', baseUrl);
                console.log('èŠå¤©ID:', chatId);
                
                // æ„å»ºå®Œæ•´URL
                const chatUrl = baseUrl + 'chat/' + chatId;
                console.log('å®Œæ•´URL:', chatUrl);
                
                // è®°å½•å¯¼èˆªå‰URL
                console.log('å½“å‰URL:', window.location.href);
                
                // ä½¿ç”¨ç¡¬å¯¼èˆªç¡®ä¿é¡µé¢åˆ·æ–°
                window.location.href = chatUrl;
            } catch(e) {
                console.error('å¯¼èˆªåˆ°èŠå¤©å‡ºé”™:', e);
                
                // åå¤‡æ–¹æ¡ˆ
                if (window.location.hostname.includes('github.io')) {
                    window.location.href = '/grokbot/chat/' + chatId;
                } else {
                    window.location.href = '/chat/' + chatId;
                }
            }
        };
        
        // åœ¨é¡µé¢åŠ è½½æ—¶å¤„ç†SPAè·¯ç”±é—®é¢˜
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–è·¯ç”±å¢å¼º...');
            
            // æ·»åŠ GitHub Pagesçš„è·¯ç”±æ”¯æŒ
            if (window.location.hostname.includes('github.io')) {
                // å¦‚æœå½“å‰åœ¨GitHub Pageså¹¶ä¸”é¡µé¢è¢«åˆ·æ–°ï¼ˆéBlazorå¯¼èˆªï¼‰
                console.log('åœ¨GitHub Pagesç¯å¢ƒä¸­è¿è¡Œ');
                
                // è·å–å½“å‰URLè·¯å¾„
                var path = window.location.pathname;
                console.log('å½“å‰è·¯å¾„:', path);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯èŠå¤©é¡µé¢è·¯å¾„çš„æ ¼å¼ï¼Œä½†å¯èƒ½è¢«æˆªæ–­
                // ä¾‹å¦‚ /grokbot/chat/123 å¯èƒ½è¢«GitHub Pagesè¿”å›404å¹¶é‡å®šå‘åˆ° /grokbot/
                var baseHref = document.querySelector('base').getAttribute('href');
                console.log('Base Href:', baseHref);
                
                // åœ¨ä¼šè¯å­˜å‚¨ä¸­æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„èŠå¤©URL
                var savedChatUrl = sessionStorage.getItem('currentChatUrl');
                if (savedChatUrl) {
                    console.log('æ‰¾åˆ°ä¿å­˜çš„èŠå¤©URL:', savedChatUrl);
                    
                    // å¦‚æœè¢«é‡å®šå‘åˆ°äº†æ ¹è·¯å¾„ï¼Œä½†æœ‰ä¿å­˜çš„èŠå¤©URLï¼Œåˆ™æ¢å¤åˆ°é‚£ä¸ªURL
                    if (path === baseHref || path === baseHref.slice(0, -1)) {
                        console.log('æ£€æµ‹åˆ°å¯èƒ½çš„é‡å®šå‘ï¼Œæ­£åœ¨æ¢å¤èŠå¤©URL');
                        // ä¿æŒURLä½†ä¸è¦ç§»é™¤ï¼Œå› ä¸ºå¦‚æœå¯¼èˆªå¤±è´¥ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡å°è¯•
                        window.location.href = savedChatUrl;
                    }
                }
            }
            
            // æ¯æ¬¡åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            window.showDebugInfo();
        });
        
        // ä¿®å¤ç‰¹æ®Šå¤„ç†æ‰€æœ‰ a æ ‡ç­¾çš„ç‚¹å‡»äº‹ä»¶
        document.addEventListener('click', function(e) {
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†aæ ‡ç­¾
            const anchor = e.target.closest('a');
            if (!anchor) return;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å†…éƒ¨é“¾æ¥
            const href = anchor.getAttribute('href');
            if (!href || href.startsWith('http') || href.startsWith('//') || href.startsWith('#')) return;
            
            console.log('æ•è·é“¾æ¥ç‚¹å‡»: ' + href);
            
            // è·å–å½“å‰baseè·¯å¾„
            const base = document.querySelector('base').getAttribute('href') || '/';
            
            // åœ¨GitHub Pagesç¯å¢ƒä¸‹é‡å†™é“¾æ¥
            if (window.location.hostname.includes('github.io')) {
                e.preventDefault();
                const newHref = base + href.replace(/^\//, '');
                console.log('é‡å†™é“¾æ¥: ' + newHref);
                window.location.href = newHref;
            }
        });

        // ä¿å­˜/æ¢å¤èŠå¤©å†…å®¹çš„åŠŸèƒ½å¢å¼º
        window.saveChatToLocalStorage = function(chatId, messages) {
            try {
                localStorage.setItem('chat_' + chatId, JSON.stringify(messages));
                console.log('å·²ä¿å­˜èŠå¤©: ' + chatId);
                return true;
            } catch (e) {
                console.error('ä¿å­˜èŠå¤©å‡ºé”™: ', e);
                return false;
            }
        };

        window.loadChatFromLocalStorage = function(chatId) {
            try {
                const data = localStorage.getItem('chat_' + chatId);
                if (data) {
                    console.log('å·²åŠ è½½èŠå¤©: ' + chatId);
                    return JSON.parse(data);
                }
                return null;
            } catch (e) {
                console.error('åŠ è½½èŠå¤©å‡ºé”™: ', e);
                return null;
            }
        };
        
        // è°ƒè¯•ä¿¡æ¯ - æ˜¾ç¤ºå½“å‰è·¯å¾„å’Œæœ¬åœ°å­˜å‚¨ä¿¡æ¯
        window.showDebugInfo = function() {
            console.log('---- è°ƒè¯•ä¿¡æ¯ ----');
            console.log('å½“å‰URL:', window.location.href);
            console.log('åŸºç¡€è·¯å¾„:', document.querySelector('base').getAttribute('href'));
            
            // æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯å­˜å‚¨
            console.log('ä¼šè¯å­˜å‚¨:');
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                console.log(`  ${key}: ${sessionStorage.getItem(key).substring(0, 50)}...`);
            }
            
            // æ˜¾ç¤ºæ‰€æœ‰èŠå¤©ç›¸å…³æœ¬åœ°å­˜å‚¨
            console.log('èŠå¤©å­˜å‚¨:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('chat_')) {
                    const chatId = key.replace('chat_', '');
                    const data = JSON.parse(localStorage.getItem(key));
                    console.log(`  ${chatId}: æ¶ˆæ¯æ•°=${data.length || 0}`);
                }
            }
            
            console.log('---------------');
        };

        // ä¿®å¤ScrollToBottomåŠŸèƒ½
        window.scrollToBottom = function(elementId) {
            try {
                if (typeof elementId === 'object') {
                    // å¦‚æœä¼ å…¥çš„æ˜¯ElementReference
                    elementId.scrollTop = elementId.scrollHeight;
                } else {
                    // å¦‚æœä¼ å…¥çš„æ˜¯IDå­—ç¬¦ä¸²
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.scrollTop = element.scrollHeight;
                    }
                }
            } catch (e) {
                console.error('æ»šåŠ¨åˆ°åº•éƒ¨å‡ºé”™: ', e);
            }
        };
        
        // å¦‚æœæ£€æµ‹åˆ°æ˜¯èŠå¤©é¡µé¢ï¼Œè®¾ç½®URL
        if (window.location.pathname.includes('/chat/')) {
            console.log('æ£€æµ‹åˆ°èŠå¤©é¡µé¢, ä¿å­˜URLåˆ°ä¼šè¯å­˜å‚¨');
            sessionStorage.setItem('currentChatUrl', window.location.href);
            
            // æå–èŠå¤©IDå¹¶å°è¯•è®°å½•
            try {
                const pathParts = window.location.pathname.split('/');
                const chatId = pathParts[pathParts.length - 1];
                console.log('æ£€æµ‹åˆ°èŠå¤©ID:', chatId);
            } catch (e) {
                console.error('æ— æ³•æå–èŠå¤©ID:', e);
            }
        }
    </script>
</body>

</html>
