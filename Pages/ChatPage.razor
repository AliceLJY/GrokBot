@page "/chat/{ChatId}"
@using GrokBot.Models
@using GrokBot.Services
@using GrokBot.Shared
@inject ChatStorageService ChatStorage
@inject GrokService GrokService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="chat-container">
    @if (currentChat == null)
    {
        <div class="loading">
            <p><em>Loading chat...</em></p>
        </div>
    }
    else
    {
        <div class="chat-header">
            <h2>@currentChat.Title</h2>
            <div>
                <button class="btn btn-sm btn-outline-secondary" @onclick="RenameChat" disabled="@isProcessing">
                    <span class="oi oi-pencil"></span> Rename
                </button>
                <button class="btn btn-sm btn-outline-secondary ml-2" @onclick="NavigateToHome" disabled="@isProcessing">
                    <span class="oi oi-home"></span> Home
                </button>
            </div>
        </div>

        <div class="messages-container" @ref="messagesContainerRef">
            @if (!currentChat.Messages.Any())
            {
                <div class="empty-chat">
                    <p>Start chatting with GrokBot!</p>
                </div>
            }
            else
            {
                @foreach (var message in currentChat.Messages)
                {
                    <MessageItem Message="message" />
                }
            }
            
            @if (isProcessing)
            {
                <div class="processing-indicator">
                    <div class="dot-flashing"></div>
                    <span>GrokBot is thinking...</span>
                </div>
            }
        </div>

        <div class="chat-input-container">
            <textarea 
                @bind="userInput" 
                @bind:event="oninput" 
                @onkeydown="HandleKeyDown"
                class="chat-input" 
                placeholder="Type your message here..."
                disabled="@isProcessing"
                rows="1"></textarea>
            <button 
                class="send-button @(string.IsNullOrWhiteSpace(userInput) || isProcessing ? "disabled" : "")" 
                @onclick="SendMessage"
                disabled="@(string.IsNullOrWhiteSpace(userInput) || isProcessing)">
                <span class="oi oi-chevron-right"></span>
            </button>
        </div>
    }
</div>

@code {
    [Parameter]
    public string ChatId { get; set; } = string.Empty;

    private Chat? currentChat;
    private string userInput = string.Empty;
    private bool isProcessing = false;
    private ElementReference messagesContainerRef;
    private bool isGitHubPages;
    private string basePath;
    private bool isFirstLoad = true;
    private bool loadAttempted = false;
    private int loadAttempts = 0;
    private const int MAX_LOAD_ATTEMPTS = 3;

    protected override async Task OnInitializedAsync()
    {
        // 检查是否在 GitHub Pages 环境
        isGitHubPages = NavigationManager.BaseUri.Contains("github.io");
        basePath = NavigationManager.BaseUri;
        
        // 记录重要信息到控制台
        await JSRuntime.InvokeVoidAsync("console.log", $"ChatPage初始化，ChatId: {ChatId}");
        await JSRuntime.InvokeVoidAsync("console.log", $"BaseUri: {basePath}");
        await JSRuntime.InvokeVoidAsync("console.log", $"Is GitHub Pages: {isGitHubPages}");
        
        // 防止无限重定向，设置标记
        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "lastChatId", ChatId);
        await JSRuntime.InvokeVoidAsync("console.log", $"已设置会话标记: lastChatId = {ChatId}");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 第一次渲染时加载聊天内容
            await LoadChat();
            isFirstLoad = false;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // 如果聊天ID变化并且不是第一次加载，重新加载聊天
        if (!isFirstLoad && currentChat?.Id != ChatId)
        {
            await JSRuntime.InvokeVoidAsync("console.log", $"聊天ID已变更: {currentChat?.Id} -> {ChatId}");
            await LoadChat();
        }
    }

    private async Task LoadChat()
    {
        if (loadAttempted) return; // 防止重复加载
        
        loadAttempted = true;
        loadAttempts++;
        
        try
        {
            // 记录开始加载
            await JSRuntime.InvokeVoidAsync("console.log", $"开始加载聊天ID: {ChatId}, 尝试次数: {loadAttempts}");
            
            // 检查ChatId是否有效
            if (string.IsNullOrEmpty(ChatId) || ChatId.Trim().Length < 5)
            {
                await JSRuntime.InvokeVoidAsync("console.log", "ChatId无效，重定向到主页");
                NavigateToHome();
                return;
            }
            
            // 直接获取聊天
            currentChat = await ChatStorage.GetChatByIdAsync(ChatId);
            
            // 如果聊天不存在，重定向到主页
            if (currentChat == null)
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"找不到ID为{ChatId}的聊天");
                
                if (loadAttempts < MAX_LOAD_ATTEMPTS)
                {
                    // 尝试再次加载
                    loadAttempted = false;
                    await Task.Delay(500); // 短暂延迟
                    await LoadChat();
                    return;
                }
                
                // 超过最大尝试次数，返回主页
                await JSRuntime.InvokeVoidAsync("console.log", $"已达到最大尝试次数: {MAX_LOAD_ATTEMPTS}");
                NavigateToHome();
                return;
            }
            
            // 成功加载聊天
            await JSRuntime.InvokeVoidAsync("console.log", $"成功加载聊天: {currentChat.Title}, 消息数量: {currentChat.Messages.Count}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"加载聊天时出错: {ex.Message}");
            
            if (loadAttempts < MAX_LOAD_ATTEMPTS)
            {
                // 尝试再次加载
                loadAttempted = false;
                await Task.Delay(500); // 短暂延迟
                await LoadChat();
                return;
            }
            
            // 超过最大尝试次数，返回主页
            NavigateToHome();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isProcessing || currentChat == null)
            return;

        // Store the message content before clearing the input
        string messageContent = userInput.Trim();
        
        // Clear the input immediately to provide better UX
        userInput = string.Empty;
        StateHasChanged();
        
        // Add user message
        var userMessage = new Message
        {
            Role = "user",
            Content = messageContent,
            Timestamp = DateTime.Now
        };
        
        currentChat.Messages.Add(userMessage);
        
        // Update the chat title if it's the first message
        if (currentChat.Messages.Count == 1)
        {
            currentChat.Title = messageContent.Length > 30 
                ? messageContent.Substring(0, 27) + "..." 
                : messageContent;
        }
        
        await ChatStorage.SaveChatAsync(currentChat);
        
        // Scroll to bottom
        await ScrollToBottom();
        
        // Get response from Grok
        isProcessing = true;
        StateHasChanged();
        
        try
        {
            // 使用GrokService获取响应
            var response = await GrokService.GetChatResponseAsync(currentChat);
            
            // 添加助手回复
            var botMessage = new Message
            {
                Role = "assistant",
                Content = response,
                Timestamp = DateTime.Now
            };
            
            currentChat.Messages.Add(botMessage);
            await ChatStorage.SaveChatAsync(currentChat);
        }
        catch (Exception ex)
        {
            // 添加错误消息
            var errorMessage = new Message
            {
                Role = "assistant",
                Content = $"抱歉，发生错误: {ex.Message}",
                Timestamp = DateTime.Now
            };
            
            currentChat.Messages.Add(errorMessage);
            await ChatStorage.SaveChatAsync(currentChat);
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
            await ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        await Task.Delay(50); // Small delay to ensure DOM update
        await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainerRef);
    }

    private async Task RenameChat()
    {
        if (currentChat == null)
            return;
            
        var newTitle = await JSRuntime.InvokeAsync<string>("prompt", "输入新的聊天标题:", currentChat.Title);
        
        if (!string.IsNullOrWhiteSpace(newTitle))
        {
            currentChat.Title = newTitle;
            await ChatStorage.SaveChatAsync(currentChat);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            // Send on Enter, but allow Shift+Enter for new lines
            await SendMessage();
        }
    }
    
    private async void NavigateToHome()
    {
        try
        {
            // 清除导航标记，防止循环
            await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "lastChatId");
            await JSRuntime.InvokeVoidAsync("console.log", "已清除会话标记，准备导航到首页");
            
            if (isGitHubPages)
            {
                // 使用纯JavaScript导航以最大程度地减少Blazor路由干扰
                await JSRuntime.InvokeVoidAsync("eval", @"
                    try {
                        // 获取基础路径
                        var baseHref = document.querySelector('base').getAttribute('href') || '/';
                        console.log('导航到首页, 基础路径:', baseHref);
                        
                        // 直接设置location.href，强制完全刷新，确保干净状态
                        window.location.href = baseHref;
                    } catch(e) {
                        console.error('导航错误:', e);
                        // 最终后备方案
                        window.location.href = '/grokbot/';
                    }
                ");
            }
            else
            {
                // 本地环境使用强制刷新
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            // 记录错误并使用最基本的方法导航
            await JSRuntime.InvokeVoidAsync("console.error", $"导航错误: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("window.location.href", basePath);
        }
    }
}
